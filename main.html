<html>
<head>
  <title>ESPM 50AC Final Project: Wind Visualization Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>  
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
</head>
<body>
  <div class="topcorner" style='position: absolute; z-index: 2'><svg width="480" height="250"></svg></div>
  <!-- <div id="map" style='height: 1000px'></div> -->
  <div id="map"  style='height: 1000px; z-index: 1'></div> 
  <script src='master.js'></script>
  <script>
    // ^ in-line styling is cursed!
    // The chart portion is forked from brandonhaydu's and caravinden's code.
    // Trying to understand https://bl.ocks.org/caravinden/d04238c4c9770020ff6867ee92c7dac1 and https://bl.ocks.org/Golodhros/6f8e6d1792416ee3770ff4ddd5c9594e
    //**************************chart*****************************************
    var barChart = function(marker, inputData) {
      const xValue = d => d.value;
      const xLabel = 'X-axis of the wind chart';
      const yValue = d => d.name;
      const yLabel = 'Candidate';
      const margin = { left: 150, right: 30, top: 5, bottom: 75 };

      
      const svg = d3.select('svg');
      const svgRemove = svg.selectAll('*').remove();
      const width = svg.attr('width');
      const height = svg.attr('height');
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;

      const g = svg.append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);
      const xAxisG = g.append('g')
          .attr('transform', `translate(0, ${innerHeight})`);
      const yAxisG = g.append('g');

      xAxisG.append('text')
          .attr('class', 'axis-label')
          //.attr('x', innerWidth / 2)
          .attr('x', 30)
          .attr('y', 55)
          .text(xLabel);

      const xScale = d3.scaleLinear();
      const yScale = d3.scaleBand()
        .paddingInner(0.3)
        .paddingOuter(0);

      const xTicks = 5;
      const xAxis = d3.axisBottom()
        .scale(xScale)
        .ticks(xTicks)
        .tickPadding(5)
        .tickFormat(d3.format('.0s'))
        .tickSize(-innerHeight);

      const yAxis = d3.axisLeft()
        .scale(yScale)
        .tickPadding(5)
        .tickSize(-innerWidth);

      const row = d => {
        return {
          county: d.countyfp10,
          attributes:[
          {
            name: 'Clinton', 
            value: Number(d.pres_clinton)
          },
          {
            name: 'Trump', 
            value: Number(d.pres_trump)
        },
          {
            name: 'Johnson', 
            value: Number(d.pres_johnson)
        },
          {
            name: 'Stein', 
            value: Number(d.pres_stein)
        },
          {
            name: 'Lariva', 
            value: Number(d.pres_lariva)
        },
          {
            name: 'Other', 
            value: Number(d.pres_other)
        }
      ]
        };
      };

      const top5 = data => data.slice(0, 5);      
      
      //function filterCriteria(d) {
      //	return d.county === '037';
      //};
        function filterCriteria(d) {
        return d.county === countyFP;
      };

      /*d3.csv('http://0.0.0.0:8000/IND_Dehradun.421110_ISHRAE.epw', row, data => {        
      //data = top5(data);
      //console.log(data);
      //data = data.filter(filterCriteria);
      //data = data[0]['attributes'];
      //console.log(data);
      //console.log(Object.keys(data)[0]);
      
      yScale
        //.domain(data.map(yValue).reverse())
        .domain([0, 100])
        .range([innerHeight, 0]);

      xScale
        .domain([0, d3.max(data, xValue)])
        .range([0, innerWidth])
        .nice(xTicks);

      g.selectAll('rect').data(data)
        .enter().append('rect')
          .attr('x', 0)
          .attr('y', d => yScale(yValue(d)))
          .attr('width', d => xScale(xValue(d)))
          .attr('height', d => yScale.bandwidth())
          .attr('fill', 'steelblue');
      

      xAxisG.call(xAxis);

      yAxisG.call(yAxis);
      yAxisG.selectAll('.tick line').remove();
      });*/
    };
    barChart(); // Draw the frame.
    //**************************chart*****************************************

    var lastHoveredMarker;


    // Add pop-ups for each marker
    function popUpTheTitle(feature, marker) {
      // does this feature have a property named title?
      if (feature.properties && feature.properties.title) {
        //marker.bindPopup(feature.properties.title);
        // Let's see if d3 can get epw from the link.
        //var exampleEPWURL = 'https://energyplus.net/weather-download/asia_wmo_region_2/IND//IND_Dehradun.421110_ISHRAE/IND_Dehradun.421110_ISHRAE.epw';
        // Must enter the index page using http://0.0.0.0:8000/main.html' due to CORS policy of Chrome
        var exampleEPWURL_local = 'http://0.0.0.0:8000/IND_Dehradun.421110_ISHRAE.epw';
        //var epw_raw = d3.csv.parseRows(exampleEPWURL);
        //var epw_raw;
        // Use d3 to fetch the epw file.
        d3.csv(exampleEPWURL_local)
          .then(function(data) {
            //console.log(data[0]["LOCATION"]); // data is an array of dictionaries
            epw_partial = data[0]["LOCATION"];
            //console.log(epw_partial);
            //marker.bindPopup(epw_partial);
            marker.bindPopup(epw_partial);
          })
          
        // Update the chart on mousehover
        marker.on('mouseover', function(e) {
          // TODO: Update the barChart object defined in above section
          // Better remember the last pointed marker to avoid
          //barChart
          if (!lastHoveredMarker || lastHoveredMarker != feature.properties.title) { // Only update on new points
            barChart()
            console.log('Mouse hovered over ' + feature.properties.title); 
            lastHoveredMarker = feature.properties.title;
          } else {
            console.log("Not updating, try another point.");
          }
        });
        marker.on('mouseover', function(e) {
           // We are not flushing the chart on mouseover for now.
        });
      }
    }

    // Don't draw every point in the world. Just California.
    function pointInCalifornia(feature, marker) {
      //if (feature.geometry && feature.geometry.coordinates) {
        //return feature.geometry.coordinates[0]
      //}
      if (feature.properties && feature.properties.title) {
        // Look for two patterns in the title.
        return feature.properties.title.match(/^USA_CA/) || feature.properties.title.match(/^CZ/); 
      }
      return false;
    }

    // Now start drawing with leaflet.js
    var map = L.map('map').setView([37.8716, -122.2727], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var geojsonFeatureCollection = master_json;

    // Using the onEachFeature option here, each point is a 'feature'
    geoJSONLayer = L.geoJSON(geojsonFeatureCollection, {
      filter: pointInCalifornia,
      onEachFeature: popUpTheTitle
    }).addTo(map); // Replace this with customized json parsing
    
    //geoJSONLayer.addData();
    // To be added

  </script>
</body>
</html>