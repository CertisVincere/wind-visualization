<html>
<head>
  <title>ESPM 50AC Final Project: Wind Visualization Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>  
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
</head>
<body>
  <div class="topcorner" style='position: absolute; z-index: 2'><svg width="480" height="250"></svg></div>
  <!-- <div id="map" style='height: 1000px'></div> -->
  <div id="map"  style='height: 1000px; z-index: 1'></div> 
  <script src='master.js'></script>
  <script>
    var epw_raw; // Make it global
    // ^ in-line styling is cursed!
    // TODO: chart covers markers sometimes, move the chart to a more convenienet position.
    // The chart portion is forked from brandonhaydu's and caravinden's code.
    // Trying to understand https://bl.ocks.org/caravinden/d04238c4c9770020ff6867ee92c7dac1 and https://bl.ocks.org/Golodhros/6f8e6d1792416ee3770ff4ddd5c9594e
    //**************************chart*****************************************
    //var barChart = function(marker, inputData) {
    var barChart = function(dataFileLocation)  {
      var svg = d3.select("svg"),
          margin = {top: 20, right: 20, bottom: 30, left: 100},
          width = +svg.attr("width") - margin.left - margin.right,
          height = +svg.attr("height") - margin.top - margin.bottom;

      var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
          y = d3.scaleLinear().rangeRound([height, 0]);

      var g = svg.append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      console.log(dataFileLocation);
      d3.tsv(dataFileLocation)
          .then((data) => {
              return data.map((d) => {
                d.potential = +d.potential;

                return d;  
              });
          })
          .then((data) => {
              x.domain(data.map(function(d) { return d.month; }));
              y.domain([0, d3.max(data, function(d) { return d.potential; })]);

              g.append("g")
                  .attr("class", "axis axis--x")
                  .attr("transform", "translate(0," + height + ")")
                  .call(d3.axisBottom(x));

              g.append("g")
                  .attr("class", "axis axis--y")
                  .call(d3.axisLeft(y).ticks(10, "%"))
                .append("text")
                  .attr("transform", "rotate(-90)")
                  .attr("y", 6)
                  .attr("dy", "0.71em")
                  .attr("text-anchor", "end")
                  .text("potential");

              g.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                  .attr("class", "bar")
                  .attr("x", function(d) { return x(d.month); })
                  .attr("y", function(d) { return y(d.potential); })
                  .attr("width", x.bandwidth())
                  .attr("height", function(d) { return height - y(d.potential); });
          })
          .catch((error) => {
              throw error;
          });
    };
    //barChart("data.tsv"); // Draw the frame.
    //**************************chart*****************************************

    var lastHoveredMarker;
    var exampleEPWURL = 'https://energyplus.net/weather-download/asia_wmo_region_2/IND//IND_Dehradun.421110_ISHRAE/IND_Dehradun.421110_ISHRAE.epw';
    // Must enter the index page using http://127.0.0.1:8000/main.html' due to CORS policy of Chrome
    var exampleEPWURL_local = 'http://127.0.0.1:8000/IND_Dehradun.421110_ISHRAE.epw';
    

    // Add pop-ups for each marker
    function popUpTheTitle(feature, marker) {
      // does this feature have a property named title?
      if (feature.properties && feature.properties.title) {
        marker.bindPopup(feature.properties.title);
        // Update the chart on mousehover
        marker.on('mouseover', function(e) {
          // TODO: Update the barChart object defined in above section
          // Better remember the last pointed marker to avoid
          //barChart
          if (!lastHoveredMarker || lastHoveredMarker != feature.properties.title) { // Only update on new points
            console.log('Mouse hovered over ' + feature.properties.title); 
            lastHoveredMarker = feature.properties.title;

            d3.csv(exampleEPWURL_local) // TODO: Feed marker-specific data
              .then(function(raw_epw) {
                columns = raw_epw["columns"]
                var epw_partial = columns[1] + ' at ' + columns[6] + ', ' + columns[7];
                console.log(epw_partial);

                var parsedCol = [...Array(12).keys()]; // WindSpeed. Using predefined values for now. Parse from CSV later.
                var months = ["Jan", "Feb", "Mar", "April", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                
                barChart("data.tsv");
              });

          } else {
            console.log("Not updating, try another marker.");
          }
        });
        //marker.on('mouseover', function(e) {
           // We are not flushing the chart on mouseover for now.
        //});
      }
    }

    // Don't draw every point in the world. Just California.
    function pointInCalifornia(feature, marker) {
      //if (feature.geometry && feature.geometry.coordinates) {
        //return feature.geometry.coordinates[0]
      //}
      if (feature.properties && feature.properties.title) {
        // Look for two patterns in the title.
        return feature.properties.title.match(/^USA_CA/) || feature.properties.title.match(/^CZ\d/); 
      }
      return false;
    }

    // Now start drawing with leaflet.js
    var map = L.map('map').setView([37.8716, -122.2727], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var geojsonFeatureCollection = master_json;

    // Using the onEachFeature option here, each point is a 'feature'
    geoJSONLayer = L.geoJSON(geojsonFeatureCollection, {
      filter: pointInCalifornia,
      onEachFeature: popUpTheTitle
    }).addTo(map); // Replace this with customized json parsing
    
    //geoJSONLayer.addData();
    // To be added

  </script>
</body>
</html>